(function(){"use strict";function h(a){let e=a>>>0;return function(){e+=1831565813;let t=Math.imul(e^e>>>15,1|e);return t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}}function d(a){let e=-1,o=-1;for(let t=0;t<a.length-1;t++)if(a[t]===255&&a[t+1]===218&&e<0&&(e=t+2),a[t]===255&&a[t+1]===217){o=t;break}return e>=0&&o>e?{start:e,end:o}:null}const w=(a,e,o,t=1337,c="safe")=>{const f=h(t),u=Math.max(0,Math.min(100,e))/100;let s=64,i=a.length-10;if(c==="safe"){const r=d(a);r?(s=r.start+16,i=r.end-2):s=256}else s=32;const g=Math.max(0,o);for(let r=0;r<g;r++)if(f()<u){const n=Math.floor(s+f()*(i-s));a[n]=a[n]+Math.floor(Math.random()*255)&255}};self.onmessage=async a=>{const e=a.data;if(!e||e.type!=="encodeCorrupt")return;const{id:o,width:t,height:c,quality:f,amount:u,iterations:s,bitmap:i,seed:g,mode:r}=e;try{const n=new OffscreenCanvas(t,c),l=n.getContext("2d",{alpha:!1});if(!l)throw new Error("OffscreenCanvas 2D context not available");l.drawImage(i,0,0,t,c),i.close();const M=await n.convertToBlob({type:"image/jpeg",quality:f}),m=new Uint8Array(await M.arrayBuffer());w(m,u,s,g??1337,r??"safe");const B=new Blob([m],{type:"image/jpeg"}),p=await createImageBitmap(B),x={id:o,type:"result",ok:!0,imageBitmap:p};self.postMessage(x,[p])}catch(n){const l={id:o,type:"result",ok:!1,error:String((n==null?void 0:n.message)||n)};self.postMessage(l)}}})();
