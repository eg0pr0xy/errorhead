name: Media Import Lock

on:
  pull_request:
    branches: [ main ]

jobs:
  verify-shared-entry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify single shared media entry contract
        run: |
          set -euo pipefail
          echo "Checking App.tsx for single handler and calls"
          grep -E -n "const\s+handleFileSelect\s*=\s*\(file:\s*File\)" App.tsx
          grep -E -n "file\.type\.startsWith\('video/'\)" App.tsx
          grep -E -n "loadVideoTo\(videoRef\.current,\s*canvasRef\.current,\s*file,\s*lastObjectUrlRef\)" App.tsx
          grep -E -n "loadImageTo\(imgRef\.current,\s*canvasRef\.current,\s*file,\s*lastObjectUrlRef\)" App.tsx

          echo "Checking hidden source elements"
          grep -E -n "<img\s+ref=\{imgRef\}" App.tsx
          grep -E -n "<video\s+ref=\{videoRef\}" App.tsx

          echo "Checking loaders for original ready hooks"
          grep -E -n "img\.onload\s*=\s*" media_loader/mediaLoader.ts
          grep -E -n "video\.onloadedmetadata\s*=\s*" media_loader/mediaLoader.ts

      - name: Enforce no multi-event finish flows in loader (lock)
        run: |
          set -euo pipefail
          echo "Ensuring no forbidden patterns in media loader"
          # These patterns previously caused regressions by racing dimension readiness.
          if grep -E -n "(loadeddata|canplay)" media_loader/mediaLoader.ts; then
            echo "Forbidden event handler detected in media loader" && exit 1
          fi
          if grep -E -n "addEventListener\s*\(\s*'(loaded|canplay)" media_loader/mediaLoader.ts; then
            echo "Forbidden addEventListener for media readiness detected" && exit 1
          fi
          if grep -E -n "function\s+finish\s*\(|const\s+finish\s*=\s*\(" media_loader/mediaLoader.ts; then
            echo "Forbidden finish() aggregator detected in loader" && exit 1
          fi

      - name: Verify file input routes into handler
        run: |
          set -euo pipefail
          grep -E -n "onChange=\{\(e\)\s*=>\s*\{[\s\S]*onFileSelect\(f\)" components/Panels/FilePanel.tsx
